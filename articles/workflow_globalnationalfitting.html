<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Workflow for FPET global fitting for national-level estimation • fpet2</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Workflow for FPET global fitting for national-level estimation">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">fpet2</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.2</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/localnational.html">FPET: Local fitting for national estimation for all women</a></li>
    <li><a class="dropdown-item" href="../articles/workflow_globalnationalfitting.html">Workflow for FPET global fitting for national-level estimation</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/AlkemaLab/fpet2/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Workflow for FPET global fitting for national-level estimation</h1>
                        <h4 data-toc-skip class="author">Leontine
Alkema</h4>
            
            <h4 data-toc-skip class="date">2025-11-25</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/AlkemaLab/fpet2/blob/main/vignettes/articles/workflow_globalnationalfitting.Rmd" class="external-link"><code>vignettes/articles/workflow_globalnationalfitting.Rmd</code></a></small>
      <div class="d-none name"><code>workflow_globalnationalfitting.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>In this vignette we illustrate how to do global fitting for national
estimation of family planning indicators using the FPET2 R package.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/AlkemaLab/fpet2" class="external-link">fpet2</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>cmdstanr_warn_inits <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="global-survey-data-base">Global survey data base<a class="anchor" aria-label="anchor" href="#global-survey-data-base"></a>
</h2>
<p>For global fitting, we use a global data base of survey data. We also
use meta information on countries and world regions.</p>
<p>Read data</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data_folder</span> <span class="op">&lt;-</span> <span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://here.r-lib.org/reference/here.html" class="external-link">here</a></span><span class="op">(</span><span class="st">"data-raw"</span><span class="op">)</span></span>
<span><span class="va">survey_data_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">data_folder</span>, <span class="st">"Track20 2025 Database for FPET2 051325.csv"</span><span class="op">)</span></span>
<span><span class="va">survey_df_all</span> <span class="op">&lt;-</span> <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_csv</a></span><span class="op">(</span><span class="va">survey_data_file</span>, show_col_types <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>Global national model fitting is done separately per marital group.
We illustrate it here for married women.</p>
<p>We process the data for that marital group:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">is_married</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/process_data.html">process_data</a></span><span class="op">(</span><span class="va">survey_df_all</span>,</span>
<span>                    regions_dat <span class="op">=</span> <span class="fu">fpet2</span><span class="fu">::</span><span class="va"><a href="../reference/regions_all.html">regions_all</a></span>,</span>
<span>                    is_married <span class="op">=</span> <span class="va">is_married</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "When imputing SEs for DHS, we use the effective sample size of its preceding survey"</span></span></code></pre>
<pre><code><span><span class="co">## Joining with `by = join_by(record_id_fixed)`</span></span>
<span><span class="co">## Joining with `by = join_by(record_id_fixed)`</span></span></code></pre>
<pre><code><span><span class="co">## [1] "We define possible outliers based on column possible_outlier"</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="model-settings-mcmc-settings-and-output-directory">Model settings: MCMC settings and output directory<a class="anchor" aria-label="anchor" href="#model-settings-mcmc-settings-and-output-directory"></a>
</h2>
<p>For model fitting, we define MCMC settings. We can choose a test
setting or a longer run. We use a test setting here for illustration
only. NOTE THAT THIS WILL PRODUCE WARNINGS AND RESULTS THAT ARE NOT TO
BE USED!!</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># test settings</span></span>
<span><span class="va">chains</span> <span class="op">=</span> <span class="fl">4</span></span>
<span><span class="va">iter_sampling</span> <span class="op">=</span> <span class="fl">5</span></span>
<span><span class="va">iter_warmup</span> <span class="op">=</span> <span class="fl">5</span></span>
<span></span>
<span><span class="co"># longer run</span></span>
<span><span class="co"># chains = 16</span></span>
<span><span class="co"># iter_sampling = 50</span></span>
<span><span class="co"># iter_warmup = 150</span></span></code></pre></div>
<p>When fitting the model, outputs are saved in an output directory.
There are different options to define this directory. By default, the
directory is automatically created one directory up from this package’s
directory, in a directory called <code>bayestransition_output</code>.
Alternatively (and easier for this article), the user can specify an
output directory to use:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create an output directory in a temporary location</span></span>
<span><span class="va">output_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"vignette_output"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">output_dir</span>, showWarnings <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Print the path so the user knows where to find it</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Outputs are saved in:"</span>, <span class="va">output_dir</span>, <span class="st">"\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Outputs are saved in: /tmp/Rtmp8bOERs/vignette_output</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="model-fitting">Model fitting<a class="anchor" aria-label="anchor" href="#model-fitting"></a>
</h2>
<p>The <code>fit_model</code> function is used for global model fitting.
Its help function explains its use. Its argument <code>run_step</code>
is used to define the type of model fitting. For global national
fitting, we do the following fits:</p>
<ul>
<li><p><code>runstep = "step1a"</code>: Get longterm trends by fitting a
model witout AR(1) deviation terms;</p></li>
<li><p><code>runstep = "step1b"</code>: Estimate parameters governing
country-specific variations in transition functions, short-term
fluctuations and data quality;</p></li>
<li><p><code>runstep = "step2"</code>: Estimate parameters associated
with traditional use.</p></li>
</ul>
<p>Let’s start with 1a:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit1a</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_model.html">fit_model</a></span><span class="op">(</span>runstep <span class="op">=</span> <span class="st">"step1a"</span>,</span>
<span>                   survey_df <span class="op">=</span> <span class="va">dat</span>,</span>
<span>                   is_married <span class="op">=</span> <span class="va">is_married</span>,</span>
<span>                   get_posteriors <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                   output_dir <span class="op">=</span> <span class="va">output_dir</span>, </span>
<span>                   chains <span class="op">=</span> <span class="va">chains</span>,</span>
<span>                   iter_sampling <span class="op">=</span>  <span class="va">iter_sampling</span>,</span>
<span>                   iter_warmup <span class="op">=</span> <span class="va">iter_warmup</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "For 1a, we take all levels from the fit_model inputs"</span></span>
<span><span class="co">## [1] "We do not fix any terms or sigmas of hierarchical models."</span></span>
<span><span class="co">## [1] "For 1a, we take all levels from the fit_model inputs"</span></span>
<span><span class="co">## [1] "We do not fix any terms or sigmas of hierarchical models."</span></span>
<span><span class="co">## [1] "We do give nonSE to DHS (by temporarily renaming DHS into DHS0)"</span></span>
<span><span class="co">## [1] "output directory is /tmp/Rtmp8bOERs/vignette_output"</span></span>
<span><span class="co">## Running MCMC with 4 parallel chains...</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Chain 1 WARNING: No variance estimation is </span></span>
<span><span class="co">## Chain 1          performed for num_warmup &lt; 20 </span></span>
<span><span class="co">## Chain 2 WARNING: No variance estimation is </span></span>
<span><span class="co">## Chain 2          performed for num_warmup &lt; 20 </span></span>
<span><span class="co">## Chain 3 WARNING: No variance estimation is </span></span>
<span><span class="co">## Chain 3          performed for num_warmup &lt; 20 </span></span>
<span><span class="co">## Chain 4 WARNING: No variance estimation is </span></span>
<span><span class="co">## Chain 4          performed for num_warmup &lt; 20 </span></span>
<span><span class="co">## Chain 3 Iteration: 1 / 10 [ 10%]  (Warmup) </span></span>
<span><span class="co">## Chain 1 Iteration: 1 / 10 [ 10%]  (Warmup) </span></span>
<span><span class="co">## Chain 2 Iteration: 1 / 10 [ 10%]  (Warmup) </span></span>
<span><span class="co">## Chain 4 Iteration: 1 / 10 [ 10%]  (Warmup) </span></span>
<span><span class="co">## Chain 2 Iteration: 6 / 10 [ 60%]  (Sampling) </span></span>
<span><span class="co">## Chain 1 Iteration: 6 / 10 [ 60%]  (Sampling) </span></span>
<span><span class="co">## Chain 2 Iteration: 10 / 10 [100%]  (Sampling) </span></span>
<span><span class="co">## Chain 2 finished in 0.5 seconds.</span></span>
<span><span class="co">## Chain 1 Iteration: 10 / 10 [100%]  (Sampling) </span></span>
<span><span class="co">## Chain 1 finished in 0.8 seconds.</span></span>
<span><span class="co">## Chain 3 Iteration: 6 / 10 [ 60%]  (Sampling) </span></span>
<span><span class="co">## Chain 3 Iteration: 10 / 10 [100%]  (Sampling) </span></span>
<span><span class="co">## Chain 3 finished in 3.2 seconds.</span></span>
<span><span class="co">## Chain 4 Iteration: 6 / 10 [ 60%]  (Sampling) </span></span>
<span><span class="co">## Chain 4 Iteration: 10 / 10 [100%]  (Sampling) </span></span>
<span><span class="co">## Chain 4 finished in 13.4 seconds.</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## All 4 chains finished successfully.</span></span>
<span><span class="co">## Mean chain execution time: 4.5 seconds.</span></span>
<span><span class="co">## Total execution time: 14.0 seconds.</span></span></code></pre>
<pre><code><span><span class="co">## Warning: 20 of 20 (100.0%) transitions ended with a divergence.</span></span>
<span><span class="co">## See https://mc-stan.org/misc/warnings for details.</span></span></code></pre>
<p>Outputs are stored in</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit1a</span><span class="op">$</span><span class="va">output_dir</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "/tmp/Rtmp8bOERs/vignette_output"</span></span></code></pre>
<p>The next fit 1b needs summary information from 1a passed on through
its <code>global_fit</code> object. Here we pass the one we just fitted.
For fit1b, we also update the outlier classifications in the survey data
used, to allow for data points that are outlying in fit 1a to be
possibly outlying, as follows:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat_updated</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/update_nooutlier_in_global_fit.html">update_nooutlier_in_global_fit</a></span><span class="op">(</span><span class="va">fit1a</span>, <span class="va">is_married</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning: Dropping 'draws_df' class as required metadata was removed.</span></span>
<span><span class="co">## Warning: Dropping 'draws_df' class as required metadata was removed.</span></span></code></pre>
<pre><code><span><span class="co">## Joining with `by = join_by(i)`</span></span>
<span><span class="co">## Joining with `by = join_by(c)`</span></span></code></pre>
<p>Now let’s fit step 1b:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit1b</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_model.html">fit_model</a></span><span class="op">(</span>runstep <span class="op">=</span> <span class="st">"step1b"</span>,</span>
<span>                   global_fit <span class="op">=</span> <span class="va">fit1a</span>,</span>
<span>                   survey_df <span class="op">=</span> <span class="va">dat_updated</span>,</span>
<span>                   is_married <span class="op">=</span> <span class="va">is_married</span>,</span>
<span>                    output_dir <span class="op">=</span> <span class="va">output_dir</span>, </span>
<span>                   get_posteriors <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                   chains <span class="op">=</span> <span class="va">chains</span>,</span>
<span>                   iter_sampling <span class="op">=</span>  <span class="va">iter_sampling</span>,</span>
<span>                   iter_warmup <span class="op">=</span> <span class="va">iter_warmup</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "We use a global fit, and take selected settings from there."</span></span>
<span><span class="co">## [1] "settings for the spline_degree and num_knots taken from global run"</span></span>
<span><span class="co">## [1] "Setting for tstar taken from global run"</span></span>
<span><span class="co">## [1] "We take all hier terms from the global fit, using prefix"</span></span>
<span><span class="co">## [1] "For hierarchical terms, we fix things up to the 2nd-lowest level."</span></span>
<span><span class="co">## [1] "For sigma terms in hierarchical models for demand and ds, we fix things up to the 2nd-lowest level."</span></span>
<span><span class="co">## [1] "We take all hier terms from the global fit, using prefix"</span></span>
<span><span class="co">## [1] "For hierarchical terms, we fix things up to the 2nd-lowest level."</span></span>
<span><span class="co">## [1] "For sigma terms in hierarchical models for demand and ds, we fix things up to the 2nd-lowest level."</span></span>
<span><span class="co">## [1] "output directory is /tmp/Rtmp8bOERs/vignette_output"</span></span>
<span><span class="co">## Running MCMC with 4 parallel chains...</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Chain 1 WARNING: No variance estimation is </span></span>
<span><span class="co">## Chain 1          performed for num_warmup &lt; 20 </span></span>
<span><span class="co">## Chain 2 WARNING: No variance estimation is </span></span>
<span><span class="co">## Chain 2          performed for num_warmup &lt; 20 </span></span>
<span><span class="co">## Chain 3 WARNING: No variance estimation is </span></span>
<span><span class="co">## Chain 3          performed for num_warmup &lt; 20 </span></span>
<span><span class="co">## Chain 4 WARNING: No variance estimation is </span></span>
<span><span class="co">## Chain 4          performed for num_warmup &lt; 20 </span></span>
<span><span class="co">## Chain 1 Iteration: 1 / 10 [ 10%]  (Warmup) </span></span>
<span><span class="co">## Chain 2 Iteration: 1 / 10 [ 10%]  (Warmup) </span></span>
<span><span class="co">## Chain 3 Iteration: 1 / 10 [ 10%]  (Warmup) </span></span>
<span><span class="co">## Chain 4 Iteration: 1 / 10 [ 10%]  (Warmup) </span></span>
<span><span class="co">## Chain 2 Iteration: 6 / 10 [ 60%]  (Sampling) </span></span>
<span><span class="co">## Chain 2 Iteration: 10 / 10 [100%]  (Sampling) </span></span>
<span><span class="co">## Chain 2 finished in 1.9 seconds.</span></span>
<span><span class="co">## Chain 3 Iteration: 6 / 10 [ 60%]  (Sampling) </span></span>
<span><span class="co">## Chain 3 Iteration: 10 / 10 [100%]  (Sampling) </span></span>
<span><span class="co">## Chain 3 finished in 3.2 seconds.</span></span>
<span><span class="co">## Chain 4 Iteration: 6 / 10 [ 60%]  (Sampling) </span></span>
<span><span class="co">## Chain 1 Iteration: 6 / 10 [ 60%]  (Sampling) </span></span>
<span><span class="co">## Chain 4 Iteration: 10 / 10 [100%]  (Sampling) </span></span>
<span><span class="co">## Chain 4 finished in 3.7 seconds.</span></span>
<span><span class="co">## Chain 1 Iteration: 10 / 10 [100%]  (Sampling) </span></span>
<span><span class="co">## Chain 1 finished in 4.2 seconds.</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## All 4 chains finished successfully.</span></span>
<span><span class="co">## Mean chain execution time: 3.3 seconds.</span></span>
<span><span class="co">## Total execution time: 4.7 seconds.</span></span></code></pre>
<pre><code><span><span class="co">## Warning: 20 of 20 (100.0%) transitions ended with a divergence.</span></span>
<span><span class="co">## See https://mc-stan.org/misc/warnings for details.</span></span></code></pre>
<p>In step 2, the parameters for traditional use are estimated:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_model.html">fit_model</a></span><span class="op">(</span>runstep <span class="op">=</span> <span class="st">"step2"</span>,</span>
<span>                   global_fit <span class="op">=</span> <span class="va">fit1b</span>,</span>
<span>                   survey_df <span class="op">=</span> <span class="va">dat_updated</span>,</span>
<span>                   is_married <span class="op">=</span> <span class="va">is_married</span>,</span>
<span>                   get_posteriors <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                  output_dir <span class="op">=</span> <span class="va">output_dir</span>, </span>
<span>                  chains <span class="op">=</span> <span class="va">chains</span>,</span>
<span>                  iter_sampling <span class="op">=</span>  <span class="va">iter_sampling</span>,</span>
<span>                  iter_warmup <span class="op">=</span> <span class="va">iter_warmup</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "We use a global fit, and take selected settings from there."</span></span>
<span><span class="co">## [1] "settings for the spline_degree and num_knots taken from global run"</span></span>
<span><span class="co">## [1] "Setting for tstar taken from global run"</span></span>
<span><span class="co">## [1] "We take all hier terms from the global fit, using prefix"</span></span>
<span><span class="co">## [1] "For hierarchical terms, we fix things up to the 2nd-lowest level."</span></span>
<span><span class="co">## [1] "We fix all sigmas of hierarchical models for demand and ds."</span></span>
<span><span class="co">## [1] "We take all hier terms from the global fit, using prefix"</span></span>
<span><span class="co">## [1] "For hierarchical terms, we fix things up to the 2nd-lowest level."</span></span>
<span><span class="co">## [1] "We fix all sigmas of hierarchical models for demand and ds."</span></span>
<span><span class="co">## [1] "For 2, we take all levels for trad from the fit_model inputs"</span></span>
<span><span class="co">## [1] "We do not fix any terms or sigmas of hierarchical models."</span></span>
<span><span class="co">## [1] "output directory is /tmp/Rtmp8bOERs/vignette_output"</span></span>
<span><span class="co">## Running MCMC with 4 parallel chains...</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Chain 1 WARNING: No variance estimation is </span></span>
<span><span class="co">## Chain 1          performed for num_warmup &lt; 20 </span></span>
<span><span class="co">## Chain 2 WARNING: No variance estimation is </span></span>
<span><span class="co">## Chain 2          performed for num_warmup &lt; 20 </span></span>
<span><span class="co">## Chain 3 WARNING: No variance estimation is </span></span>
<span><span class="co">## Chain 3          performed for num_warmup &lt; 20 </span></span>
<span><span class="co">## Chain 4 WARNING: No variance estimation is </span></span>
<span><span class="co">## Chain 4          performed for num_warmup &lt; 20 </span></span>
<span><span class="co">## Chain 1 Iteration: 1 / 10 [ 10%]  (Warmup) </span></span>
<span><span class="co">## Chain 2 Iteration: 1 / 10 [ 10%]  (Warmup) </span></span>
<span><span class="co">## Chain 3 Iteration: 1 / 10 [ 10%]  (Warmup) </span></span>
<span><span class="co">## Chain 4 Iteration: 1 / 10 [ 10%]  (Warmup) </span></span>
<span><span class="co">## Chain 1 Iteration: 6 / 10 [ 60%]  (Sampling) </span></span>
<span><span class="co">## Chain 1 Iteration: 10 / 10 [100%]  (Sampling) </span></span>
<span><span class="co">## Chain 4 Iteration: 6 / 10 [ 60%]  (Sampling) </span></span>
<span><span class="co">## Chain 1 finished in 1.5 seconds.</span></span>
<span><span class="co">## Chain 4 Iteration: 10 / 10 [100%]  (Sampling) </span></span>
<span><span class="co">## Chain 4 finished in 1.9 seconds.</span></span>
<span><span class="co">## Chain 2 Iteration: 6 / 10 [ 60%]  (Sampling) </span></span>
<span><span class="co">## Chain 2 Iteration: 10 / 10 [100%]  (Sampling) </span></span>
<span><span class="co">## Chain 2 finished in 4.8 seconds.</span></span>
<span><span class="co">## Chain 3 Iteration: 6 / 10 [ 60%]  (Sampling) </span></span>
<span><span class="co">## Chain 3 Iteration: 10 / 10 [100%]  (Sampling) </span></span>
<span><span class="co">## Chain 3 finished in 6.3 seconds.</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## All 4 chains finished successfully.</span></span>
<span><span class="co">## Mean chain execution time: 3.6 seconds.</span></span>
<span><span class="co">## Total execution time: 7.1 seconds.</span></span></code></pre>
<pre><code><span><span class="co">## Warning: 20 of 20 (100.0%) transitions ended with a divergence.</span></span>
<span><span class="co">## See https://mc-stan.org/misc/warnings for details.</span></span></code></pre>
<p>We can plot all estimates using the <code>plot_estimates_local</code>
function. Relevant code is added below. We are not showing results
hereto avoid confusion, given that test settings were used, so the
results are incorrect.</p>
<p>Let’s create the results first:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">results2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">results2</span><span class="op">$</span><span class="va">estimates</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_estimates_globalruns.html">get_estimates_globalruns</a></span><span class="op">(</span></span>
<span>  samples <span class="op">=</span> <span class="va">fit2</span><span class="op">$</span><span class="va">samples</span>, </span>
<span>  geo_unit_index <span class="op">=</span> <span class="va">fit2</span><span class="op">$</span><span class="va">geo_unit_index</span>,</span>
<span>  time_index <span class="op">=</span> <span class="va">fit2</span><span class="op">$</span><span class="va">time_index</span>,</span>
<span>  marital_status <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">is_married</span>, <span class="st">"married"</span>, <span class="st">"unmarried"</span><span class="op">)</span>,</span>
<span>  return_samples <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>Add uncertainty in observations (so that we can display the 95% CIs
associated with each data point):</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">results2</span><span class="op">$</span><span class="va">observations</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/add_uncertainty_in_obs.html">add_uncertainty_in_obs</a></span><span class="op">(</span>fit  <span class="op">=</span> <span class="va">fit2</span><span class="op">)</span></span></code></pre></div>
<p>Now let’s plot! (again, not showing the results…)</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plots</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/plot_estimates_local_all.html">plot_estimates_local_all</a></span><span class="op">(</span></span>
<span>      results <span class="op">=</span> <span class="va">results2</span>,</span>
<span>      marital_status_all <span class="op">=</span>  <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">is_married</span>, <span class="st">"married"</span>, <span class="st">"unmarried"</span><span class="op">)</span>,</span>
<span>      indicator_select_all <span class="op">=</span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"contraceptive_use_modern"</span>,</span>
<span>                 <span class="st">"unmet_need_modern"</span>,</span>
<span>                 <span class="st">"demand"</span>, <span class="co">#"demand_satisfied_modern",</span></span>
<span>                 <span class="st">"contraceptive_use_traditional"</span><span class="op">)</span>,</span>
<span>      save_plots <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co"># plots are in a list, eg check </span></span>
<span><span class="va">plots</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="local-fitting">Local fitting<a class="anchor" aria-label="anchor" href="#local-fitting"></a>
</h2>
<p>For local fitting, the <code>fit_model</code> function can be used as
well, using <code>runstep = "local_national"</code>. This results in
local fitting for one marital group. For local fitting for all women,
the function <code>fit_fpem</code> can be used (see other article).</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Leontine Alkema, Herbert Susmann, Shauna Mooney, Evan Ray.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
